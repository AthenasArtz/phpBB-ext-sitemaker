!function($,window,document,undefined){"use strict";var editorVal="",editing=!1,updated=!1,dialogEditOpened=!1,blockPositions={},emptyPositionsObj={},template={},origin={},inlineForm={},dialogConfirm={},dialogEdit={},dialogCopy={},cButtons={},dButtons={},eButtons={},lButtons={},blockObj={},blockData={},msgObj={},saveBtn={},lang={},config={},editMode=!1,phpbb={},tinymce={},twig={},fixPaths=function(t){var e=config.ext?"./../":"./../../";return t.replace(new RegExp(e,"./"))},removeGrid=function(t){t.removeClass(function(){var t=this.className.match(/grid__col+(\S+)?/gi);return t?t.join(" "):""})},sortHorizontal=function(t){var e=t.length,o=t.parent().data("columns")!==undefined?t.parent().data("columns")<=5?t.parent().data("columns"):5:3,i=e%o,n=e-i;if(o>=e)o=e;else if(t.parent().hasClass("equal")){if(i>0&&o>3)for(var a=1;i>a;a++)if(e%(o-a)===0){o-=a;break}n=e,i=0}if(removeGrid(t),n>0&&t.slice(0,n).addClass("grid__col grid__col--1-of-"+o),i){var l=1;2>i&&(l=5,i=5),t.slice(n,e).addClass("grid__col grid__col--"+l+"-of-"+i)}},showAllPositions=function(){blockPositions.addClass("show-position"),emptyPositionsObj.removeClass("empty-position").siblings(".grid__col").removeClass("lastUnit")},hideEmptyPositions=function(){blockPositions.removeClass("show-position"),emptyPositionsObj=$('.block-position:not(:has(".block"))').addClass("empty-position").each(function(t,e){$(e).siblings(".grid__col").last().addClass("lastUnit")})},makeEditable=function(t){return editing===!0?void inlineForm.children(":input").trigger("blur"):(editing=!0,editorVal=t.removeClass("editable").text(),void inlineForm.show().appendTo(t.text("")).children(":input").val(editorVal).focus().select().end())},undoEditable=function(t){var e=inlineForm.parent();editing=!1,editorVal="",e.addClass("editable").text(t),inlineForm.hide().appendTo($("body"))},renderBlock=function(blockObj,blockData){var id="block-editor-"+blockData.id;tinymce.get(id)&&(tinymce.EditorManager.execCommand("mceFocus",!1,id),tinymce.EditorManager.execCommand("mceRemoveEditor",!0,id)),blockObj.html(template.render(blockData)),"blitze.sitemaker.block.custom"===blockData.name&&(blockObj.find("#"+id).length?tinymce.EditorManager.execCommand("mceAddEditor",!1,id):blockData.content.indexOf("script")>-1&&eval(blockObj.find(".sm-block-content").html()))},saveLayout=function(){var t={};$(".block-position").each(function(){var e=0,o=$(this).attr("id");$(this).find(".block").each(function(i,n){var a=$(n).attr("id");if(o!==undefined&&a!==undefined){var l=a.substring(6);t[l]={position:o.substring(4),weight:e},e++}})}),$.post(config.ajaxUrl+"/blocks/save_blocks",{route:config.route,blocks:t},function(){saveBtn.button("disable"),updated=!1})},addBlock=function(t,e,o){$(o).removeAttr("role aria-disabled data-block class style").addClass("block").html('<div class="ui-state-highlight sm-block-spacing sortable" style="padding: 5px"><i class="fa fa-spinner fa-2x fa-spin"></i> '+lang.ajaxLoading+"</div>");var i={block:$.trim(e),weight:o.parent().find(".block").index(o),route:config.route,ext:config.ext,position:t};$.getJSON(config.ajaxUrl+"/blocks/add_block",i,function(t){if(updated=!1,""===t.id)return void $(o).remove();var e=$(o).attr("id","block-"+t.id);renderBlock(e,t),e.children().not(".block-controls").show("scale",{percent:100},1e3),updated&&saveLayout()})},placeCaretAtEnd=function(t){if(t.focus(),"undefined"!=typeof window.getSelection&&"undefined"!=typeof document.createRange){var e=document.createRange();e.selectNodeContents(t),e.collapse(!1);var o=window.getSelection();o.removeAllRanges(),o.addRange(e)}else if("undefined"!=typeof document.body.createTextRange){var i=document.body.createTextRange();i.moveToElementText(t),i.collapse(!1),i.select()}},getEditForm=function(t){$.getJSON(config.ajaxUrl+"/blocks/edit_block",{id:t.attr("id").substring(6)},function(t){blockData=t,t.form&&(dialogEdit.html(t.form),dialogEdit.find("#block-settings").tabs(),dialogEdit.find("select[data-togglable-settings]").each(function(){var t=$(this);t.change(function(){phpbb.toggleSelectSettings(t)}),phpbb.toggleSelectSettings(t)}),dialogEdit.dialog({buttons:eButtons}).dialog("option","title",lang.edit+" - "+t.title).dialog("open"),setTimeout(function(){placeCaretAtEnd(dialogEdit.find("#block_class").get(0))},1e3))})},getCustomClasses=function(){return dialogEdit.find("#block_class").text().trim()},saveForm=function(t){var e=$("#edit_form"),o=dialogEdit.dialog("widget").find("#update-similar:checked").length,i={id:t.attr("id").substring(6),route:config.route,similar:o};e.serializeArray().map(function(t){i[t.name]=t.value}),i["config[source]"]&&(i["config[source]"]=encodeURI(i["config[source]"])),i["class"]=getCustomClasses(),dialogEdit.dialog("close"),$.post(config.ajaxUrl+"/blocks/save_block",i,function(t){t.list&&$.each(t.list,function(t,e){e.content=fixPaths(e.content),renderBlock($("#block-"+e.id),e)})})},updateBlock=function(t){return t.id===undefined?!1:void $.post(config.ajaxUrl+"/blocks/update_block?route="+config.route,t,function(t){editing===!0&&undoEditable(t.title)})},customBlockAction=function(t){t.id!==undefined&&$.post(config.ajaxUrl+"/blocks/handle_custom_action",t,function(t){"function"==typeof phpbb.ajaxCallbacks[t.callback]&&phpbb.ajaxCallbacks[t.callback].call(undefined,t)})},setDefaultLayout=function(t){$.post(config.ajaxUrl+"/blocks/set_default_route?route="+(t===!0?config.route:""))},setStartPage=function(t){$.post(config.ajaxUrl+"/blocks/set_startpage",$.param(t))},setRoutePrefs=function(t){$.post(config.ajaxUrl+"/blocks/set_route_prefs?route="+config.route+"&ext="+config.ext,t.serialize())},copyBlocks=function(t){var e=$(".block-position");$.getJSON(config.ajaxUrl+"/blocks/copy_route?route="+config.route+"&ext="+config.ext+"&"+$.param(t),function(t){0!==t.list.length&&(showAllPositions(),e.empty(),$.each(t.list,function(t,e){var o=$("#pos-"+t);$.each(e,function(t,e){e.content=fixPaths(e.content);var i=template.render(e);o.append('<div id="block-'+e.id+'" class="unit size1of1 block"></div>'),o.find("#block-"+e.id).html(i)}),o.hasClass("horizontal")&&sortHorizontal(o.find(".block"))}),hideEmptyPositions())})},processInput=function(t){if(editing!==!1){var e=$(t).parentsUntil(".block").parent().attr("id").substring(6),o=$(t).val();return e&&o!==editorVal?updateBlock({id:e,field:"title",title:o}):undoEditable(editorVal),!1}},previewBlock=function(){var t=$.extend(!0,{},blockData),e=dialogEdit.find("#edit_form").serializeArray();$.each(e,function(){t[this.name]=this.value}),t["class"]=getCustomClasses(),renderBlock(blockObj,t)},undoPreviewBlock=function(){renderBlock(blockObj,blockData)},initTinyMce=function(){tinymce.init({selector:"div.editable-block",inline:!0,image_advtab:!0,hidden_input:!1,plugins:["advlist autolink lists link image charmap preview hr anchor pagebreak","visualblocks visualchars code","media nonbreaking save table contextmenu directionality","paste textcolor colorpicker textpattern imagetools"],toolbar:["undo redo | styleselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify","bullist numlist outdent indent | hr pagebreak | image media | link | table | preview code"],valid_elements:"*[*]",end_container_on_empty_block:!0,setup:function(t){var e="",o="";t.on("blur",function(){var i=t.getContent({format:"raw"});if(t.getContent().length>0){var n=$("#"+t.id).data("raw",i).data();i!==o&&i!==lang.placeholder?(n.id=t.id.substring(13),n.content=i,customBlockAction(n)):t.setContent(e)}else e?t.setContent(e):t.setContent(lang.placeholder)}),t.on("init",function(){0===t.getContent().length&&t.setContent(lang.placeholder)}),t.on("focus",function(){o=$("#"+t.id).data("raw"),e=t.getContent({format:"raw"}),t.setContent(o)})}})},showMessage=function(t){t&&(msgObj.html(t),msgObj.fadeIn().delay(3e3).fadeOut())},showCurrentState=function(t,e){t?showMessage('<span><i class="fa fa-info-circle fa-blue fa-lg"></i> '+lang.hidingBlocks+"</span>"):e.length&&showMessage('<span><i class="fa fa-info-circle fa-blue fa-lg"></i> '+lang.hidingPos+": <strong>"+e.join(", ")+"</strong></span>")};$(document).ready(function(){editMode=window.editMode||!1,lang=window.lang||{},phpbb=window.phpbb||{},tinymce=window.tinymce||{},twig=window.twig||{},config=window.config||{ajaxUrl:"",boardUrl:"",route:"",ext:"",style:""};var t="",e={},o={},i={},n={},a=!1,l=$("#admin-bar").show().find("#admin-control").click(function(){return editMode?($(this).toggleClass("admin-bar-toggler").prev().toggle(),e.toggleClass("push-down"),!1):void 0}).find("i");if(editMode){inlineForm=$('<form class="inline-form"><input type="text" class="inline-edit" value="" /></form>').hide().appendTo($("body")),msgObj=$("#ajax-message"),emptyPositionsObj=$('.block-position:not(:has(".block"))').addClass("empty-position"),template=twig({data:$.trim($("#block-template-container").html())}),$("#add-block-panel").find(".sitemaker-block").draggable({addClasses:!1,iframeFix:!0,opacity:.7,helper:"clone",appendTo:"body",revert:"invalid",connectToSortable:".block-position",start:function(t,e){$(e.helper).addClass("dragging"),showAllPositions(),blockPositions.sortable("refresh"),o.trigger("click")},stop:function(){window.setTimeout(function(){updated===!1&&hideEmptyPositions()},600)}}),i=$("#ex_positions"),blockPositions=$(".block-position").addClass("block-receiver").sortable({revert:!0,placeholder:"ui-state-highlight grid__col sm-block-spacing block sortable placeholder",connectWith:".block-position",cancel:".editable-block, .inline-edit",items:".block",tolerance:"pointer",cursor:"move",cursorAt:{top:-10,left:-10},start:function(t,e){origin=$(e.item).addClass("dragging").parent(".horizontal"),showAllPositions(),blockPositions.sortable("refresh")},over:function(t,e){n=e.placeholder.parent(".horizontal").children(".block").addClass("sortable")},out:function(){$.isEmptyObject(n)===!1&&n.removeClass("sortable")},update:function(t,e){if(updated=!0,$(e.item).attr("id")===undefined){var o=$(this).attr("id").substring(4),i=$(e.item).attr("data-block"),n=$(this).find('div[data-block="'+i+'"]');addBlock(o,i,n)}else saveBtn.button("enable");var a=$(e.item).removeAttr("style").parent(".horizontal").children(".block"),l=$(e.item);l.parent().removeClass("empty-position"),removeGrid(l),a.length>0&&sortHorizontal(a),origin.attr("id")!==$(e.item).parent(".horizontal").attr("id")&&sortHorizontal(origin.find(".block").removeClass("sortable"))},stop:function(t,e){$(e.item).removeClass("dragging sortable").removeAttr("style"),hideEmptyPositions(),$("body").trigger("layoutChanged")}}).on("click",".block-title",function(){makeEditable($(this))}).on("submit",".inline-form",function(t){t.preventDefault(),$(this).find(".inline-edit").trigger("blur")}).on("focusout",".inline-edit",function(){processInput($(this))}).on("click",".edit-block",function(t){t.preventDefault(),blockObj=$(this).parentsUntil(".block").parent(),getEditForm(blockObj)}).on("click",".delete-block",function(t){t.preventDefault(),blockObj=$(this).parentsUntil(".block").parent(),dialogConfirm.dialog({buttons:dButtons}).dialog("open")}).each(function(t,e){var o=$(e).attr("id").substring(4);0===i.find("option[value="+o+"]").length&&i.append('<option value="'+o+'">'+o+"</option>")}),phpbb.addAjaxCallback("previewCustomBlock",function(t){$("#block-editor-"+t.id).html(t.content.replace("./../../",""))}),saveBtn=$("#toggle-edit").button().click(function(){}).parent().next().children("a").button({disabled:!0}).click(function(t){t.preventDefault(),saveLayout()}),$(".has-dropdown").click(function(t){t.preventDefault(),$(this).parentsUntil("ul").parent().find(".dropped").not($(this)).removeClass("dropped").next().hide(),o=$(this).toggleClass("dropped"),o.next().toggle()}).next().mouseleave(function(){}),$("#admin-options").show(100,function(){var t=$.grep(i.val(),function(t){return t.length});showCurrentState(a,t),e=$("body").addClass("push-down")});var s=$("#style-options");s.find("option").length>1&&s.show(),$.ajaxSetup({beforeSend:function(t,e){l.addClass("fa-spinner fa-green fa-spin fa-lg fa-pulse"),e.url+=(e.url.indexOf("?")<0?"?":"&")+"style="+config.style},complete:function(t){l.delay(2e3).removeClass("fa-spinner fa-green fa-spin fa-lg fa-pulse"),t.responseJSON&&(t.responseJSON.message&&showMessage(t.responseJSON.message),t.responseJSON.content&&(t.responseJSON.content=fixPaths(t.responseJSON.content)))},error:function(t){showMessage(t.responseJSON&&t.responseJSON.message?t.responseJSON.message:lang.ajaxError)}}),eButtons[lang.edit]=function(){saveForm(blockObj)},eButtons[lang.cancel]=function(){undoPreviewBlock(),$(this).dialog("close")},dButtons[lang.remove]=function(){var t=blockObj.parent(".horizontal");blockObj.remove(),t.find(".ui-effects-placeholder").remove();var e=t.find(".block");e.length>0&&sortHorizontal(e),hideEmptyPositions(),saveBtn.button("enable"),$(this).dialog("close")},dButtons[lang.cancel]=function(){$(this).dialog("close")};var c={autoOpen:!1,modal:!0,width:"auto",show:"slide",hide:"slide"};dialogConfirm=$("#dialog-confirm").dialog(c),lButtons[lang.deleteAll]=function(){$(this).dialog("close"),$(".block-position").empty(),hideEmptyPositions(),saveBtn.button("enable"),updated=!0},lButtons[lang.cancel]=function(){$(this).dialog("close")};var r=$("#dialog-delete-all").dialog(c),d=$("#delete-blocks").button().click(function(t){t.preventDefault(),r.dialog({buttons:lButtons}).dialog("open")});cButtons[lang.copy]=function(){$(this).dialog("close"),copyBlocks(t),d.parent().show()},cButtons[lang.cancel]=function(){$(this).dialog("close")},dialogCopy=$("#dialog-copy").dialog(c),$("#copy-form").find(".layout-action").button().click(function(e){e.preventDefault(),t=$(this).parent().parent().serializeArray();var i=t[0].value,n=t[1].value,a=$(this).data("action");if(""===i||i===config.route&&n===config.style)return!1;if("copy"===a)o.trigger("click"),dialogCopy.dialog({buttons:cButtons}).dialog("open");else{var l="";l+=("/"===i.substring(0,1)?config.ajaxUrl:config.boardUrl+"/")+i,l+=(l.indexOf("?")>=0?"&":"?")+"style="+n+"&edit_mode=1",window.location.href=l}}),c.open=function(){if(dialogEditOpened===!1){var t=$(this).dialog("widget").find(".ui-dialog-buttonpane");dialogEditOpened=!0,$('<label class="dialog-check-button"><input id="update-similar" type="checkbox" />'+lang.updateSimilar+"</label>").prependTo(t)}},dialogEdit=$("#dialog-edit").dialog(c).on("click",".block-class-actions",function(t){t.preventDefault();var e=$(this).data("action"),o=dialogEdit.find("#block_class");switch(e){case"clear":o.text("").change();break;case"toggle":dialogEdit.find($(this).attr("href")).slideToggle();break;case"undo":case"redo":o.focus(),document.execCommand(e,!1,null),o.change()}}).on("click",".class-cat",function(t){var e=$(this).attr("href"),o=$("#classes-scroller");o.animate({scrollTop:o.scrollTop()+$(e).position().top},1e3),t.preventDefault()}).on("click",".transform",function(t){var e=dialogEdit.find("#block_class"),o=e.text().length,i=o?" ":"";document.execCommand("insertText",!1,i+$(this).text()),e.change(),t.preventDefault()}).on("change",".block-preview",function(){previewBlock()}),$(".default-layout").button().click(function(t){var e=$(this).data("set");setDefaultLayout(e),t.preventDefault(),e===!0?($(this).parent().hide().next().hide().next().show(),d.parent().hide()):($(this).parent().hide().prev().hide().prev().show(),d.parent().show())}),$(".sm-startpage").button().click(function(t){t.preventDefault();var e={};"set-startpage"===$(this).attr("id")?($(this).parent().hide().next().show(),e={controller:$(this).data("controller"),method:$(this).data("method"),params:$(this).data("params")},setStartPage(e)):($(this).parent().hide().prev().show(),setStartPage(e))}),a=$("#route-settings").submit(function(t){setRoutePrefs($(this)),t.preventDefault()}).find("#hide_blocks").is(":checked"),window.onbeforeunload=function(t){return updated===!0?(t=t||window.event,t&&(t.returnValue=lang.leaveConfirm),lang.leaveConfirm):void 0},$(".sitemaker").iconPicker({selector:".block-icon",onSelect:function(t,e,o){var i=t.parentsUntil(".block").parent().attr("id").substring(6);updateBlock({id:i,icon:o})}}),initTinyMce()}})}(jQuery,window,document);
//# sourceMappingURL=manager.min.js.map
