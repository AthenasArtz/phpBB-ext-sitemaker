!function(e,t,i,s){"use strict";var n=t.lang||{},o=t.Twig||{},d={};e.widget("sitemaker.treeBuilder",{options:{ajaxUrl:"",loadSpeed:10,fields:{itemId:"item_id",itemTitle:"item_title",parentId:"parent_id"},listType:"ol",noNesting:".no-nest",nestedList:"#sortable",editForm:"#edit-form",noItems:"#no-items",addBtn:"#add-new",addBulkBtn:"#add-bulk",addBulkList:"#add_list",saveBtn:"#save",deleteSelBtn:"#delete-selected",rebuildBtn:"#rebuild-tree",selectAll:"#select-all",loading:"#loading",ajaxMessage:"#ajax-message",itemTemplate:"#item-template",actionClass:".item-action",selectItemClass:".select-item",iconSelectClass:".icon-select",dialogEdit:"",dialogConfirm:"#dialog-confirm",loaded:function(){},updated:function(){}},_create:function(){var s=this,a={},l={},r={};this.nestedList=this.element.addClass("tree-builder").find(this.options.nestedList).nestedSortable({disableNesting:this.options.noNesting,forcePlaceholderSize:!0,listType:this.options.listType,handle:"div",helper:"clone",items:"li",opacity:.6,placeholder:"placeholder",tabSize:25,tolerance:"pointer",toleranceElement:"> div",errorClass:this.options.ajaxMessage,update:function(){s.itemsChanged=!0,s.saveBtn.button("option","disabled")&&s.saveBtn.button("option","disabled",!1)}}),this.selectAllObj=this.element.find(this.options.selectAll).click(function(){s.nestedList.find(s.options.selectItemClass).prop("checked",this.checked),this.checked?s.deleteSelBtn.button("enable"):s.deleteSelBtn.button("disable")}),l[n.deleteChildNodes]=function(){var t=e("li#item-"+s.itemID);s._removeNode(t),e(this).dialog("close"),s._saveTree()},l[n.deleteNode]=function(){var t=e("li#item-"+s.itemID);t.children(s.options.listType).length&&t.children(s.options.listType).children("li").appendTo(t.parent(s.options.listType)),s._removeNode(t),e(this).dialog("close"),s._saveTree()},l[n.cancel]=function(){e(this).dialog("close")},a[n.saveNode]=function(){s._checkRequired()&&(s._submitForm(s.itemID),e(this).dialog("close"))},a[n.cancel]=function(){e(s.dialogID).dialog("close")},r[n.deleteNode]=function(){s.element.find(s.options.selectItemClass+":checked").parentsUntil("li").parent().each(function(){s._removeNode(e(this))}),s._saveTree(),e(this).dialog("close")},r[n.cancel]=function(){e(this).dialog("close")};var h={autoOpen:!1,modal:!0,width:"auto",show:"slide",hide:"slide"};e(this.options.dialogEdit).dialog(h),e(this.options.dialogConfirm).dialog(h),this.msgObj=this.element.find(this.options.ajaxMessage);var c=this.element.find(this.options.loading);e(i).ajaxStart(function(){c.fadeIn()}).ajaxStop(function(){c.fadeOut()}).ajaxComplete(function(e,t){t.responseJSON&&t.responseJSON.message&&s.showMessage(t.responseJSON.message)}).ajaxError(function(){s.showMessage(n.errorMessage)}),t.onbeforeunload=function(e){if(!0===s.itemsChanged)return(e=e||t.event)&&(e.returnValue=n.unsavedChanges),n.unsavedChanges};var p={};p["click"+this.options.selectItemClass]=function(){var e=this.element.find(this.options.selectItemClass+":checked").length;e>0?this.deleteSelBtn.button("enable"):this.deleteSelBtn.button("disable"),e===this.element.find(this.options.selectItemClass).length?this.selectAllObj.prop("checked",!0):this.selectAllObj.prop("checked",!1)},p["click.editable"]=function(t){this._makeEditable(e(t.target))},p["blur#inline-edit"]=function(t){this._processEditable(e(t.target))},p["submit#inline-form"]=function(t){t.preventDefault(),e(t.target).find("#inline-edit").trigger("blur")},p["click"+this.options.actionClass]=function(t){var i=e(t.currentTarget).data("action");switch(this.itemID=s._getItemId(e(t.currentTarget)),i){case"edit":this.dialogID=this.options.dialogEdit,this._populateForm(this.itemID,function(t){e(t).dialog({buttons:a}).dialog("option","title",n.editNode).dialog("open")});break;case"delete":var o=e.extend({},l);this.dialogID=this.options.dialogConfirm,e("#item-"+this.itemID).children(this.options.listType).children("li").length<1&&delete o[n.deleteChildNodes],e(this.dialogID).dialog({buttons:o}).dialog("open")}},this._on(this.document,p),this.addBtn=this.element.find(this.options.addBtn).button({icons:{primary:"ui-icon-plus"}}).click(function(t){t.preventDefault(),s.options.dialogEdit.length?(s.itemID=void 0,s.dialogID=s.options.dialogEdit,s.editForm.populate({}),e(s.dialogID).dialog({buttons:a}).dialog("option","title",n.addNode).dialog("open")):s.addItem()}),this.addBulkBtn=this.element.find(this.options.addBulkBtn).button({text:!1,icons:{primary:"ui-icon-triangle-1-s"}}).click(function(t){t.preventDefault();var i=e(t.currentTarget).toggleClass("dropped").blur(),o=i.parent().next(),d=o.width(),a=i.offset(),l=o.slideToggle().offset({top:a.top+i.height()+10,left:a.left-d/2+i.width()});if(!0===i.hasClass("dropped")){var r='<option value="0">'+n.none+"</option>";l.find("select").html(s._getOptions(s.nestedList,"",r)).next().val()}}),this.addBulkBtn.parent().buttonset().show().next().hide().find("#cancel").click(function(){s.addBulkBtn.trigger("click")}).next().click(function(t){var i=e(t.target).parentsUntil("form").parent(),n={add_list:d.getValue()};n[s.options.fields.parentId]=i.find("#parent_id").val(),d.setValue(""),d.clearHistory(),s._addBulk(e.param(n)),s.addBulkBtn.trigger("click"),t.preventDefault()}),this.rebuildBtn=this.element.find(this.options.rebuildBtn).button({disabled:!0,icons:{primary:"ui-icon-refresh"}}).click(function(e){s._saveTree(),e.preventDefault()}),this.deleteSelBtn=this.element.find(this.options.deleteSelBtn).button({disabled:!0,icons:{primary:"ui-icon-trash"}}).click(function(t){s.dialogID=s.options.dialogConfirm,e(s.dialogID).dialog({buttons:r}).dialog("open"),t.preventDefault()}),this.saveBtn=this.element.find(this.options.saveBtn).button({disabled:!0,icons:{primary:"ui-icon-check"}}).click(function(e){!0===s.itemsChanged&&s._saveTree(),e.preventDefault()}),this.addBtnOffset=this.addBtn.offset(),this.noItems=this.element.find(this.options.noItems),this.editForm=e(this.options.editForm),o.twig({id:"item_template",data:this.element.find(this.options.itemTemplate).html()}),d=CodeMirror.fromTextArea(e(this.options.addBulkList).get(0),{theme:"monokai",lineNumbers:!0,lineWrapping:!1,autoRefresh:!0,styleActiveLine:!0,fixedGutter:!0,coverGutterNextToScrollbar:!1,indentWithTabs:!0,indentUnit:4}),this.getItems()},addItem:function(){this._saveItem("add_item",{})},updateItem:function(e,t){this._saveItem("update_item",e,t)},getItems:function(){var t=this;e.getJSON(this.options.ajaxUrl+"load_items",function(e){t.nestedList.empty(),t._resetActions(),void 0!==e.items&&e.items.length>0&&(t._showActions(),t._addToTree(e.items))})},getCodeMirrorInstance:function(){return d},showMessage:function(e){e&&(this.msgObj.text(e),this.msgObj.fadeIn().delay(3e3).fadeOut())},_addBulk:function(t){var i=this;e.post(this.options.ajaxUrl+"add_bulk",t,function(e){e.error?i.showMessage(e.error):(i._showActions(),i._addToTree(e.items))},"json")},_addToTree:function(t,i){if(t.length>0){var s={},o=t.shift();if(o[this.options.fields.itemTitle]=o[this.options.fields.itemTitle]||n.changeMe,o[this.options.fields.parentId]>0){var d=e("#item-"+o[this.options.fields.parentId]);0===d.children(this.options.listType).length?(s=e("<"+this.options.listType+">"+this._renderItem(o)+"</"+this.options.listType+">").hide()).appendTo(d):(s=e(this._renderItem(o)).hide()).appendTo(d.children(this.options.listType))}else(s=e(this._renderItem(o)).hide()).appendTo(this.nestedList);var a=this;s.effect("slide",{direction:"right",mode:"show"},this.options.loadSpeed,function(){a._addToTree(t,i)})}void 0!==i&&i.apply(this,[t]),this._trigger("loaded",null,{items:t})},_checkRequired:function(){e(this.dialogID+" .error").remove();var t=!0;return e(this.dialogID+" .required").each(function(){e(this).val()||(e('<div class="error">'+n.required+"</div>").insertAfter(this),t=!1)}),t},_getItemId:function(e){return e.attr("id").substring(5)},_getOptions:function(t,i,s){var n=this;return t.children("li").each(function(t,o){var d=e(o),a='<option value="'+n._getItemId(d)+'">'+(i+"&#x251c;&#x2500; "+d.find(".editable:first").text())+"</option>";s+=n._getOptions(d.children("ol"),"&nbsp;&nbsp;&nbsp;&nbsp;"+i,a)}),s},_makeEditable:function(t){!0!==this.editing?(this.editing=!0,this.editorVal=t.text()!==n.changeMe?t.text():"",t.replaceWith('<form id="inline-form"><input type="text" id="inline-edit" value="'+this.editorVal+'" /></form>'),this.editor=e("#inline-edit").data("field",t.data("field")).focus().select()):this.editor.trigger("blur")},_populateForm:function(t,i){var s=this;return e.get(this.options.ajaxUrl+"load_item?"+this.options.fields.itemId+"="+t,function(e){s.showMessage(e.message),s.editForm.populate(e),i(s.dialogID)},"json"),{}},_processEditable:function(t){if(!1!==this.editing){var i=this._getItemId(e(t).parentsUntil("li").parent()),s=e(t).data("field"),o=e(t).val(),d={};return i&&s&&o&&o!==this.editorVal?(d[s]=o,d.field=s,this._saveItem("update_item",d,i,s)):this._undoEditable(this.editorVal?this.editorVal:n.changeMe),!1}},_resetActions:function(e){var t="initial";e||(this.noItems.show(),t="none"),this.itemsChanged=!1,this.addBulkBtn.parent().next().slideUp(),this.selectAllObj.prop("checked",!1).parent().css("display",t),this.deleteSelBtn.button("disable").css("display",t),this.saveBtn.button("disable").css("display",t),this.rebuildBtn.css("display",t)},_saveItem:function(t,i,s,n){var o=this;e.post(this.options.ajaxUrl+t+(s?"?"+this.options.fields.itemId+"="+s:""),i,function(i){if(i.error)o.showMessage(i.error),o.editing&&o._undoEditable(o.editorVal);else switch(t){case"add_item":o._addToTree([i],function(){var t=e("#item-"+i[o.options.fields.itemId]);o._showActions(),o._scrollTo(t,o.addBtnOffset.top,function(){o.options.dialogEdit.length||t.find(".editable").trigger("click")})});break;case"update_item":o.editing?o._undoEditable(i[n]):o._refreshItem(i);break;case"save_item":var s=o._refreshItem(i);o._trigger("updated",null,s)}},"json")},_saveTree:function(){var t=e(this.options.nestedList).find("li").length?this.nestedList.nestedSortable("toArray"):[];this._saveItem("save_tree",{tree:t}),this._resetActions(t.length)},_scrollTo:function(e,t,i){var s=e.offset().top-t;this.nestedList.animate({scrollTop:s},1e3,i)},_showActions:function(){this.noItems.hide(),this.nestedList.show(),this.selectAllObj.parent().show(),this.deleteSelBtn.show(),this.saveBtn.show(),this.rebuildBtn.button("enable").show()},_removeNode:function(e){e.remove(),e.siblings().length||e.parent(this.options.listType).not(this.options.nestedList).remove()},_renderItem:function(e){return o.twig({ref:"item_template"}).render(e)},_refreshItem:function(t){var i=e(this._renderItem(t)).children();return e("#item-"+t[this.options.fields.itemId]).children(":first").replaceWith(i)},_undoEditable:function(e){this.editorVal="",this.editing=!1,this.editor.parent().replaceWith('<span class="editable" data-field="'+this.editor.data("field")+'">'+e+"</span>")},_submitForm:function(e){var t=e?"save_item":"add_item";this._saveItem(t,this.editForm.serializeArray(),e)}})}(jQuery,window,document);
//# sourceMappingURL=builder.min.js.map
